# プロセス切り替え
この章ではOSの要となるプロセスの切り替えを実装します。

## ARMv7-MのCPUモードについて
OSは一章でも少し説明したように通常のアプリケーションとは異なるCPUのモードで動くことが多いです。
一般にアプリケーション用のCPUモードだとシステムレジスタへのアクセスが制限されたり、使うレジスタが異なる場合や、一部のメモリにアクセスできなかったりします。
このCPUモードの切り替えによって、アプリケーションが他のアプリケーションに影響を与えたり、OSの機能を乗っ取ることを防止しているわけです。

Cortex-Mは他のアーキテクチャのCPUモードと比べると境目がかなり曖昧で制限も弱いですが、一応ちゃんと存在しています。4章でもちらっと登場しました。
ここでしっかり見てみましょう。

ARMv7-MのB1.3章を見てみましょう。ARMv7-Mではモード、特権、使用するスタックポインタを切り替えることができ、これらがシステムレベルのアーキテクチャを把握するのに重要なキーとなります。
順番に見ていきましょう。
まず、モードですが、スレッドモードとハンドラモードの2種類があります。リセット直後だとスレッドモードとなり、このモードが通常のプログラムが実行されている状態と考えることができるでしょう。
例外が発生するとハンドラモードに移行します。このモードに突入し例外処理が終わったあと、例外復帰処理をすることでまたスレッドモードに移行できます。
例外復帰処理とは4章でちょこっと説明しましたが、ARMv7-MではLRを特殊な値にセットすることで実現されます。このときのLRの値によってモードや後述する特権や使用するスタックポインタの切り替えもできます。
ここで注意したいのが、スレッドモードもハンドラモードも１章で言及した「カーネルモード」と対応するものではないということです。このモードの違いは権限を分けるためのものではないからです。

プログラムの権限を調整するのが特権です。特権状態と非特権状態が存在します。特権状態でないと実行できない命令が存在します。
ハンドラモードでは常に特権状態になりますが、スレッドモードでは非特権状態になることが可能です。
OSが実行するときはプロセッサの機能がすべて使えるように特権モードになるべきで、そうでない通常のアプリケーションの場合は非特権モードを使うのがよさそうですね。

ARMv7-Mではスタックポインタが２種類存在して使い分けることができる、ということは４章でもちらっと言いましたが、ここでちゃんと見てみましょう。
スタックポインタにはメインとプロセスの２種類存在していて、前述したモードや特権とは独立したパラメータとして設定することができます。
ただし、ハンドラモードでは常にメインが使われることになります。

## CPUの状態を切り替える
TBD