# 割り込み制御
割り込みはOSをつくる上で重要な項目の1つです。
ペリフェラルが割り込み信号を送ることで、OSは現在の実行処理を中断してペリフェラルからの処理をすることができます。

Armでは現在の実行を中断して非同期に発生するイベントを「例外処理」と呼んでいて、割り込みもその１つです。
今回はSysTickというArmに内蔵されているタイマーモジュールを例として扱ってみようと思います。
SysTickはシステムタイマーといわれていて、OSで一定周期ごとに行う処理などを実装するモジュールです。
このモジュールはARMv7-Mでは必須のモジュールであるため、今回使うNucleoのボード以外のARMv7-Mのボードでも存在するはずです。

## ARMv7-Mの例外モデル
ARMv7-MのリファレンスマニュアルB1.5章に例外処理の詳細が書かれています。
例外が発生すると、前の章で説明したVector Tableに従って処理が決定されます。
割り込みを含む例外が発生すると、例外に割り振られたIDによってVector Tableに書かれたアドレスにジャンプします。
今回扱うSysTickモジュールではB1.5.2章によると15番の例外が発生します。つまり、Vector Tableの15番目のエントリーとして呼びたい関数をおいておくことになります。

例外が発生するとき、ハードウェアがシステムの状態を自動的にスタック領域に退避してくれます。B1.5.6章を見てみましょう。
スタックにはxPSR、例外処理が完了したあとに戻るべきアドレス、LR（R14）、R12、R3からR0までが退避されます。

ここでArmのレジスタについて簡単に説明します。詳しくはB1.4章に書かれています。
ARMv7-MではR0からR15までのレジスタが使用可能です。R0からR12レジスタが汎用レジスタと呼ばれるもので、プログラム中で自由に使うことができます。
R13からR15も算術命令などで使うこともできるのですが、それぞれ特殊な意味を持つレジスタになっています。
R13がスタックポインタ（SP）になっています。現在のスタック領域のメモリアドレスを指すものです。モードによって実は２つのスタックポインタレジスタが使い分けられています。
つまり、プロセッサのモードによって一見アセンブラ命令上は同じSPでも異なるSPを指すことがあるということです。詳しくは次の章で説明します。
R14はリンクレジスタ（LR）です。これは関数の呼び出しをおこなった場合に使われるもので、その関数呼び出しから戻る先のアドレスを保存するためのレジスタです。
R15はプログラムカウンタ（PC)で、現在、実行中の命令のメモリアドレスが格納されているレジスタです。
これ以外のレジスタとしていくつかシステムレジスタが存在しています。これは通常の算術命令などではアクセスできず、特別な命令でしかアクセスできません。
そのうちの１つがプログラムスタータスレジスタ（PSR）というものです。

