<!DOCTYPE HTML>
<html lang="ja" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>スケジューラを実装する - Rustで始める自作組込みOS入門</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../1_intro/index.html"><strong aria-hidden="true">1.</strong> はじめに</a></li><li class="chapter-item expanded "><a href="../2_setup/index.html"><strong aria-hidden="true">2.</strong> 環境構築</a></li><li class="chapter-item expanded "><a href="../3_hello/index.html"><strong aria-hidden="true">3.</strong> ベアメタルでHello World</a></li><li class="chapter-item expanded "><a href="../4_interrupt/index.html"><strong aria-hidden="true">4.</strong> 割り込み</a></li><li class="chapter-item expanded "><a href="../5_process/index.html"><strong aria-hidden="true">5.</strong> プロセス切り替え</a></li><li class="chapter-item expanded "><a href="../6_scheduler/index.html" class="active"><strong aria-hidden="true">6.</strong> スケジューラを実装する</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rustで始める自作組込みOS入門</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#スケジューラを実装する" id="スケジューラを実装する">スケジューラを実装する</a></h1>
<p>前回の章でアプリケーションプロセスへの切り替えを実装しました。
しかし、現状だと再びアプリケーションに突入したり、複数のアプリケーションを動かしたり、といったことができていません。
この章では、簡単なラウンドロビン型のスケジューラを実装して複数のアプリケーションを動かすことを目標としましょう。</p>
<p>スケジューラを実装するには前章まででやってきたアプリケーションプロセスへの切り替えに加えて以下のことが必要です。</p>
<ul>
<li>次に実行可能なプロセスを指すための構造体を実装する</li>
<li>プロセスの状態をメモリ上に保管する構造体とその保存ロジックの実装</li>
</ul>
<p>順番にやっていきましょう</p>
<h2><a class="header" href="#連結リストを実装する" id="連結リストを実装する">連結リストを実装する</a></h2>
<p>スケジューラを実装するに当たって、実行中のプロセスの情報を連結リストの形式で持っておきたいです。
今回実装するスケジューラでは、実行が終わったプロセスを末尾に追加して、先頭から次に実行するプロセスを取ってくるため連結リストを利用したいです。
しかしながら、<code>no_std</code>のプログラミングではお馴染みの動的配列である<code>Vec</code>や<code>LinkedList</code>は使えないので似たような構造体がほしいです。</p>
<p>では、連結リストを<code>linked_list.rs</code>内に実装してみましょう。
C言語などで実装したことがある人がいるとは思いますが、普通はおおよそこんな感じになるでしょう。</p>
<ul>
<li>リスト内に入る各アイテムは、そのアイテムの実際の値と次のアイテムへのポインタを持つ</li>
<li>リスト構造体そのものは先頭要素へのポインタと末尾要素へのポインタを持つ</li>
<li>新しいアイテムを追加するときは現在の末尾要素の次に追加して、リストの持つ末尾要素ポインタを更新</li>
<li>先頭から要素を取り出すには先頭要素ポインタから取り出して、次の要素をリストの持つ先頭要素ポインタに更新</li>
</ul>
<p>Rustでは生ポインタもありますが、通常であればポインタよりも参照を用いた実装が好まれます。
しかし、先程あげたような機能を持つ連結リストは参照では実装は困難です。実際に見てみましょう。</p>
<p>まず、リストそのものと、リストに格納される各要素の定義は以下のような感じになるでしょう。</p>
<pre><code>pub struct ListItem&lt;'a, T&gt; {
    value: T,
    next: Option&lt;&amp;'a mut ListItem&lt;'a, T&gt;&gt;,
}

pub struct LinkedList&lt;'a, T&gt; {
    head: Option&lt;&amp;'a mut ListItem&lt;'a, T&gt;&gt;,
    last: Option&lt;&amp;'a mut ListItem&lt;'a, T&gt;&gt;,
}
</code></pre>
<p>試しに末尾に新しい要素を追加するというメソッドを実装してみましょう。素直に実装するとこんな感じでしょうか。</p>
<pre><code>impl&lt;'a, T&gt; LinkedList&lt;'a, T&gt; {
    pub fn push(&amp;mut self, item: &amp;'a mut ListItem&lt;'a, T&gt;) {
        if self.last.is_none() {
            self.last = Some(item);
            self.head = Some(item);
        } else {
            let prev_last = self.last.replace(item);
            prev_last.map(|i| i.next = Some(item));
        }
    }
}
</code></pre>
<p>しかし、これはコンパイルエラーになります。なぜなら、<code>item</code>はミュータブルな参照なのにもかかわらず、
<code>self.last</code>と<code>self.head</code>ないし1つ手前の<code>ListItem</code>の<code>next</code>の2つのメンバーに保持される必要があります。
ミュータブルな参照は複数存在できないので、このような形では素直には実装できないです。</p>
<p>では、標準ライブラリではどのように実装されているかというと、生ポインタを使うことで解決しています。
確かに生ポインタを使うことは安全ではないのですが、標準ライブラリ内部ではしばしば<code>unsafe</code>な部分が存在しています。
その代わり提供するインターフェスは生ポインタを使うことがないようにして安全でない部分を限定している、というわけです。
そういうことで、ここでは生ポインタを使うことにしましょう。その代わり、このモジュールにはテストを書いておき、きちんとバグがないよう確認しておきましょう。</p>
<p>まず、テストとしては以下のようなものを書いておきましょう。</p>
<pre><code>#[cfg(test)]
mod test {
    use ListItem;
    use LinkedList;

    #[test]
    fn test_list() {
        let mut item1 = ListItem::new(1);
        let mut item2 = ListItem::new(2);
        let mut item3 = ListItem::new(3);
        let mut list = LinkedList::new();

        list.push(&amp;mut item1);
        list.push(&amp;mut item2);
        list.push(&amp;mut item3);

        let result1: &amp;u32 = list.pop().unwrap();
        let result2: &amp;u32 = list.pop().unwrap();
        let result3: &amp;u32 = list.pop().unwrap();
        assert_eq!(1, *result1);
        assert_eq!(2, *result2);
        assert_eq!(3, *result3);

        assert!(list.is_empty());

        let mut item4 = ListItem::new(4);
        let mut item5 = ListItem::new(5);
        list.push(&amp;mut item4);
        list.push(&amp;mut item5);

        let result4: &amp;u32 = list.pop().unwrap();
        let result5: &amp;u32 = list.pop().unwrap();
        assert_eq!(4, *result4);
        assert_eq!(5, *result5);

        assert!(list.is_empty());
    }
}

</code></pre>
<p>最低限のテストではありますが、とりあえず必要なものは見えてきたと思います。
<code>list.pop().unwrap()</code>の結果を<code>&amp;u32</code>として変数に束縛していますが、これは<code>ListItem&lt;'a, T&gt;</code>に対して<a href="https://doc.rust-lang.org/std/ops/trait.Deref.html"><code>Deref</code></a>を実装していることを想定しています。
以降、生ポインタを使っての実際の実装を見せていきますが、ある程度すでにRustに習熟しているのであれば、この仕様を満たすように自力で実装するのもいいでしょう。
以下に示すのはあくまで一例です。また、実装の踏み込んだ解説はあまりしないでおきます。</p>
<p>まずは構造体そのもの定義を変えましょう。参照はすべてポインタに置き換えてしまうのが一番愚直なやりかただと思うので、そうします（もちろん一部を参照を残すこともできます）。</p>
<pre><code>use core::ptr::NonNull;
use core::marker::PhantomData;

pub struct ListItem&lt;'a, T&gt; {
    value: T,
    next: Option&lt;NonNull&lt;ListItem&lt;'a, T&gt;&gt;&gt;,
    marker: PhantomData&lt;&amp;'a ListItem&lt;'a, T&gt;&gt;,
}

pub struct LinkedList&lt;'a, T&gt; {
    head: Option&lt;NonNull&lt;ListItem&lt;'a, T&gt;&gt;&gt;,
    last: Option&lt;NonNull&lt;ListItem&lt;'a, T&gt;&gt;&gt;,
    marker: PhantomData&lt;&amp;'a ListItem&lt;'a, T&gt;&gt;,
}
</code></pre>
<p><a href="https://doc.rust-lang.org/core/ptr/struct.NonNull.html"><code>NonNull</code></a>と<a href="https://doc.rust-lang.org/core/marker/struct.PhantomData.html"><code>PhantomData</code></a>という構造体を使っています。
<code>NonNull</code>はnon-nullでないポインタを意味します。普通の<code>*mut T</code>に対して0ではないという制約がついているわけですが、これにより<code>Option</code>でくくったときに0という値を<code>None</code>として使うようにコンパイルされるため、<code>Option&lt;NonNull&lt;T&gt;&gt;</code>と<code>*mut T</code>のコンパイル後のサイズが同じという利点が生まれます。
すべてをポインタに置き換えてしまうとライフタイムの情報がなくなってしまいます。コンパイル時にこれらの情報を失わないように<code>PhantomData</code>を使ってます。
これはコンパイルされるとサイズが全くないものになるのですが、実際のメンバーのように振る舞うことで型引数をさも要求しているようにコンパイラに見せかけるための構造体です。
詳しくは公式ドキュメントを参照してください。</p>
<p>関数の実装は以下のようにしてみました。</p>
<pre><code>impl&lt;'a, T&gt; ListItem&lt;'a, T&gt; {
    pub fn new(value: T) -&gt; Self {
        ListItem {
            value,
            next: None,
            marker: PhantomData,
        }
    }
}

impl&lt;'a, T&gt; LinkedList&lt;'a, T&gt; {
    pub fn new() -&gt; Self {
        LinkedList {
            head: None,
            last: None,
            marker: PhantomData,
        }
    }

    pub fn push(&amp;mut self, item: &amp;'a mut ListItem&lt;'a, T&gt;) {
        let ptr = unsafe { NonNull::new_unchecked(item as *mut ListItem&lt;T&gt;) };
        let prev_last = self.last.replace(ptr);

        if prev_last.is_none() {
            self.head = Some(ptr);
        } else {
            prev_last.map(|mut i| unsafe {
                i.as_mut().next = Some(ptr);
            });
        }
    }

    pub fn is_empty(&amp;self) -&gt; bool {
        self.head.is_none()
    }

    pub fn pop(&amp;mut self) -&gt; Option&lt;&amp;'a mut ListItem&lt;'a, T&gt;&gt; {
        let result = self.head.take();
        let next = result.and_then(|mut ptr| unsafe {
            ptr.as_mut().next
        });

        if next.is_none() {
            self.last = None;
        }

        self.head = next;

        result.map(|ptr| unsafe { &amp;mut *ptr.as_ptr() })
    }
}
</code></pre>
<p>構造体のメンバーをすべてプライベートにしてしまっているので、<code>ListItem</code>からvalueの値を取り出すことがこのままではできません。
新たなメソッドを追加するのもいいですが、<code>Deref</code>を実装するという方法で実現してみましょう。</p>
<pre><code>use core::ops::{Deref, DerefMut};

impl&lt;'a, T&gt; Deref for ListItem&lt;'a, T&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        &amp;self.value
    }
}

impl&lt;'a, T&gt; DerefMut for ListItem&lt;'a, T&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
        &amp;mut self.value
    }
}
</code></pre>
<p>ここまで書いたところでテストを走らせたいのですが、このプロジェクト全体が標準ライブラリなしでArmへのクロスコンパイルを前提として書かれていることもあり、このまま<code>cargo test</code>を実行しても正常に動きません。
しかし、このモジュール単体はアーキテクチャへの依存がないため、このプロジェクトは切り離してのテストが可能です。
手軽な方法としては<code>rustc --test</code>でこのファイルのみをテストしてしまうことでしょうか。その際、このファイルの冒頭に<code>#![no_std]</code>をつける必要があります。
ただし、モジュールに本来クレートレベルのアトリビュートである<code>no_std</code>をつけてしまうと、プロジェクト全体をコンパイルしたときに警告が出てしまいます。
他の方法としては、これを別クレートとして新しいプロジェクトに切り出してしまうことです。これならば、その新しくつくったプロジェクト上で<code>cargo test</code>を実行すればいいです。
この方法ならば、コンパイル時の警告もないので、よりまっとうな方法になるでしょう。</p>
<h2><a class="header" href="#プロセスの状態を保存する" id="プロセスの状態を保存する">プロセスの状態を保存する</a></h2>
<p>TBD</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../5_process/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../5_process/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
